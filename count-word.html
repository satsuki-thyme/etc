<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>文字数カウンター</title>
<style>
body {
  color: #1e1f1c;
  background-color: #f1eee9;
}
#container {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  width: 300px;
  height: 60px;
  margin: auto;
  text-align: center;
}
#display {
  height: 20px;
  margin: 0;
  padding: 0;
  line-height: 20px;
}
#num {
  display: inline-block;
  width: 65px;
}
#reload {
  margin-top: 20px;
}
@media (prefers-color-scheme: dark) {
  body {
    color: #f1eee9;
    background-color: #1e1f1c;
  }
}
</style>
<div id="container">
  <p id="display">総文字数 : <span id="num"></span> 文字</p>
  <input id="reload" type="button" value="更新">
</div>
<script>
// 設定
let baseDir = "/scribe"
let indexFile = "index.json"
let listFile = "README.md"
// ノード
let nod_num = document.getElementById("num")
let nod_rel = document.getElementById("reload")
// 始める
sumLength()
// 更新
nod_rel.onclick = () => {
  location.reload()
}
/*

  主部

*/
function sumLength() {
  // 作品群のインデックスを読み込む
  fetch(`${baseDir}/${indexFile}`)
  .then(rly => {
    if (rly.ok) {
      return rly.json()
    }
    else {
      console.error(`${indexFile} の取得に失敗しました。`)
    }
  })
  .then(rly => {
    // 各物語ごとの目次を抽出する
    let i = 0
    let work = []
    return new Promise(resolve => {
      // エピソード群の目次を読み込む
      fn()
      function fn() {
        fetch(`${baseDir}/op${rly[i].op}/${listFile}`)
        .then(rly => {
          if (rly.ok) {
            return rly.text()
          }
          else {
            console.error(`${listFile} の取得に失敗しました。`)
          }
        })
        .then(rly2 => {
          work.push({
            "op": rly[i].op,
            "list": rly2 // 目次を抽出する
            .replace(/^[\s\S]*?#+[ \t]*(?:目次|本文).*\r?\n([\s\S]*)(?:#[\s\S]*|$)/g, "$1")
            .replace(/^(?:[*+-] ?|\d+\. ?)(.*?)(?:[ \t]*[:：][ \t]*.*)*$/gm, "$1")
            .split(/\r?\n/)
            .filter(rly => rly !== "")
          })
          if (i < rly.length - 1) {
            i++
            fn()
          }
          else {
            resolve(work)
          }
        })
      }
    })
  })
  .then(work => {
    work = work.filter(rly => rly.list.length !== 0)
    fileNum(work)
    let i = 0
    let lenSet = []
    return new Promise(resolve => {
      fn()
      function fn() {
        let j = 0
        let subLenSet = []
        new Promise(resolve => {
          fn()
          function fn() {
            // 各エピソードの本文をロードする
            fetch(`${baseDir}/op${work[i].op}/${work[i].list[j]}`)
            .then(rly => {
              if (rly.ok) {
                return rly.text()
              }
              else {
                console.error(`${wordFile} の取得に失敗しました。`)
              }
            })
            .then(rly => {
              subLenSet
              .push(
                rly
                .replace(/｜([^｜]*?)《.*?》/g, "$1")
                .replace(/[々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+（(.*?)）/g, "$1")
                .replace(/｜(（.*?）)/g, "$1")
                .replace(/^[ \t]*[#*+\-_~=`>|].*\r?\n/gm, "")
                .replace(/[\r\n 　\t]/g, "")
                .length
              )
              if (j < work[i].list.length - 1) {
                j++
                fn()
              }
              else {
                resolve(subLenSet)
              }
            })
          }
        })
        .then(rly => {
          lenSet.push(rly)
          if (i < work.length - 1) {
            i++
            fn()
          }
          else {
            resolve(lenSet)
          }
        })
      }
    })
  })
  .then(rly => {
    let sum = 0
    for (let i in rly) {
      let subSum = 0
      for (let j in rly[i]) {
        subSum += rly[i][j]
      }
      sum += subSum
    }
    nod_num.innerText = sum
  })
}
/*

  副次的な関数

*/
function fileNum(work) {
  let fileNum = 0
  work.map(r => fileNum += r.list.length)
  console.log(`ファイル数 : ${fileNum}`)
}
</script>
