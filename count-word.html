<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>文字数カウンター</title>
<style>
body {
  color: #1e1f1c;
  background-color: #f1eee9;
}
#container {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  width: 300px;
  height: 60px;
  margin: auto;
}
#display {
  height: 20px;
  margin: 0;
  padding: 0;
  text-align: center;
  line-height: 20px;
}
#progress-outer {
  position: relative;
  width: 200px;
  height: 20px;
  margin: 20px auto 0;
  padding: 0;
  border-width: 1px;
  border-style: solid;
  border-color: #1e1f1c;
}
#progress-inner {
  height: 100%;
  margin: 0;
  padding: 0;
  background-color: #1e1e7a;
}
#progress-message {
  position: absolute;
  width: 200px;
  margin: 0;
  padding: 0;
  font-size: 16px;
  text-align: center;
  line-height: 20px;
  color: #fff;
}
@media (prefers-color-scheme: dark) {
  body {
    color: #f1eee9;
    background-color: #1e1f1c;
  }
  #progress-outer {
    border-color: #f1eee9;
  }
  #progress-inner {
    background-color: #3b3ba0;
  }
}
</style>
<script>
// 設定
let baseDir = "/scribe"
let indexFile = "index.json"
let listFile = "README.md"
let waitingTime = 0
// 定義
let arr_listOv = []
let totalWork = 0
let progress = 0
document.addEventListener("DOMContentLoaded", () => {
  nod_num = document.getElementById("num")
  nod_progress = document.getElementById("progress-inner")
  nod_message = document.getElementById("progress-message")
})
/*

  実行

*/
loadIndex()
.then(r => {
  getTotalWork(r)
  // 各物語ごとの目次を抽出する
  for (let i in r) {
    let prm_makeList = new Promise(resolve => {
      loadList(r[i]["op"])
      .then(r2 => {
        // 目次を抽出する
        let list = r2
        .replace(/^[\s\S]*?#+[ \t]*(?:目次|本文).*\r?\n([\s\S]*)(?:#[\s\S]*|$)/g, "$1")
        .replace(/^(?:[*+-] ?|\d+\. ?)(.*?)(?:[ \t]*[:：][ \t]*.*)*$/gm, "$1")
        .split(/\r?\n/)
        .filter(r => r !== "")
        arr_listOv.push({
          "op": r[i]["op"],
          "list": list
        })
        if (i >= r.length - 1) {
          // 全物語の目次が抽出されたら resolve() する
          resolve(arr_listOv)
        }
      })
    })
    // Promise.then()
    prm_makeList
    .then(r => {
// 次の段階へ移行
      countWord(r)
    })
  }
})
// 第 2 段階
function countWord(r) {
  // 各物語ごとに処理する
  for (let i in r) {
    progres()
    // 目次が空でなければ
    if (r[i]["list"].length !== 0) {
      let subSumLen = 0
      // 各エピソードごとに処理する
      for (let j in r[i]["list"]) {
        let prm_countWord = new Promise(resolve => {
          // 各エピソードの本文をロードする
          loadWord(r[i]["op"], r[i]["list"][j])
          .then(r2 => {
            let prm_len = new Promise(resolve1 => {
              let w = r2.replace(/｜([^｜]*?)《.*?》/g, "$1")
              .replace(/[々〇〻\u3400-\u9FFF\uF900-\uFAFF\uD840-\uD87F\uDC00-\uDFFF]+（(.*?)）/g, "$1")
              .replace(/｜(（.*?）)/g, "$1")
              .replace(/^[ \t]*[#*+\-_~=`>|].*\r?\n/gm, "")
              .replace(/[\r\n 　\t]/g, "")
              .length
              resolve1(w)
            })
            prm_len
            .then(r3 => {
              console.log(r3)
              subSumLen += r3
              resolve(subSumLen)
            })
          })
        })
        prm_countWord
        .then(r3 => {
          r[i]["len"] = r3
          if (i >= r.length - 1) {
            // 次の段階へ移行
            sumLength(r)
          }
        })
      }
    }
    // 目次が空であれば
    else {
      r[i]["len"] = 0
      if (i >= r.length - 1) {
        // 次の段階へ移行
        sumLength(r)
      }
    }
  }
}
// 第 3 段階
function sumLength(listOv) {
  let sumLen = 0
  let prm_sumLength = new Promise(resolve => {
    // 各物語について処理する
    for (let i in listOv) {
      setTimeout(() => {
        progres()
        sumLen += listOv[i]["len"]
        if (i >= listOv.length - 1) {
          // 全物語について処理したら resolve()
          resolve(sumLen)
        }
      }, waitingTime)
    }
  })
  prm_sumLength
  .then(r => {
// 次の段階へ移行
    writeNum(r)
  })
}
// 第 4 段階
function writeNum(num) {
  nod_num.innerText = num
  nod_message.innerText = "Count done."
}
/*

  副次的な関数

*/
// 作品群のインデックスを読み込む
async function loadIndex() {
  let w = await fetch(`${baseDir}/${indexFile}`)
  if (w.ok) {
    return w.json()
  }
  else {
    console.error(`${indexFile} の取得に失敗しました。`)
  }
}
// エピソード群の目次を読み込む
async function loadList(op) {
  let w = await fetch(`${baseDir}/op${op}/${listFile}`)
  if (w.ok) {
    return w.text()
  }
  else {
    console.error(`${listFile} の取得に失敗しました。`)
  }
}
// エピソード自体を読み込む
async function loadWord(op, wordFile) {
  let w = await fetch(`${baseDir}/op${op}/${wordFile}`)
  if (w.ok) {
    return w.text()
  }
  else {
    console.error(`${wordFile} の取得に失敗しました。`)
  }
}
// プログレスバーのために全仕事量を算出する
function getTotalWork(index) {
  totalWork = index.length
}
// プログレスバーを進める
function progres() {
  progress += 1 / (totalWork * 2)
  nod_progress.style.width = progress * 100 + "%"
}
</script>
<div id="container">
  <p id="display">総文字数 : <span id="num"></span> 文字</p>
  <div id="progress-outer">
    <div id="progress-inner" style="width: 0;">
      <p id="progress-message">Count in progress.</p>
    </div><!-- #progress-innner -->
  </div><!-- #progress-outer -->
</div><!-- #container -->
